# Agent Guidelines for `videoaudio`

Scope: Repository root and all subdirectories.

## Working Mode
- Specification-first, but docs must reflect actual code; reconcile discrepancies and record them instead of introducing theoretical behavior.
- Feedback ohne Dateiinhalte: Responses stay Markdown-only and must not paste file bodies.
- Outputs must stay Markdown-only, concise, and free of file contents; avoid workflow dumps or class-sized code. No code snippets longer than 30 lines.
- Tests are out of scope; do not add or run automated tests unless explicitly requested.
- Any documentation changes must be mirrored in both this `AGENTS.md` and `README.md`. Capture unresolved or diverging points in `docs/OPEN_DECISIONS.md` (or equivalent compliance notes) when touched.
- ComfyUI phase is blocking submit → poll (`poll_interval_ms` default 500, `timeout_total` respected) → collect to `workdir/comfyui/comfyui_video.mp4` oder `workdir/frames/` (strict `000001.png`, `000002.png`, ... 6-stellig, sortiert nach Original-Filename); manifest stores `workflow_id`, `prompt_id`, `output_kind`, `output_paths`, plus `chunk_size`/`chunk_count` (jetzt `chunk_count=1`, `chunk_size=target_frames`). ComfyUI ist im Produktionspfad Pflicht (default enable); Health-Check erwartet `/system_stats` mit gültigem Body (kein Fallback `/health`), `/object_info` muss erreichbar sein, fehlende Nodes/Weights oder fehlende Comfy-Outputs → `COMFYUI_UNAVAILABLE`/`COMFYUI_BAD_RESPONSE`, kein Dummy/Fallback-Video bei aktivem ComfyUI. Fehlt `workflow_id` bei aktivem ComfyUI, wird der Run mit `COMFYUI_UNAVAILABLE` abgebrochen. ffmpeg liest Frames via `%06d.png`.
- Runner enforces resume/overwrite rules, measures audio via `ffprobe`, und performt echtes ffmpeg-Muxing (CFR `determinism.fps`, Audio-Padding für Buffer, Frame-Hold für Post). Visual-Priorität: ComfyUI-Video (`comfyui_video.mp4`) dominiert bei aktiviertem ComfyUI; `start_video` dient nur als Primärquelle wenn ComfyUI deaktiviert ist. Fällt ComfyUI aus und nur `start_image` existiert, erzeugt der Runner ein Seed-deterministisches Ken-Burns-Motion-Fallback, der Still-Dummy bleibt letzter Notanker. Scaling richtet sich nach der abgeleiteten Render-Auflösung; Endbild-Hold (`end_image` + Post-Puffer) wird per re-encoded Concat (scale/fps/yuv420p) stabil an das Hauptvideo gehängt, der ComfyUI-Auftrag kürzt dafür die Bildanzahl um die Post-Puffer-Frames. Temp-Verzeichnisse werden nach erfolgreichen Läufen entfernt; Frames bleiben zur Fehlersuche bestehen.
- LipSync executes when `lipsync.enable=true` and a provider exists (provider Pflicht bei aktivem LipSync; default off), config is loaded from `VA_STATE_DIR/state/config/lipsync.providers.json` (or `state_dir` in `vidax.json`), falling back to repo `config/lipsync.providers.json`; output at `workdir/lipsync/output.mp4`. `allow_passthrough=true` keeps encode alive on provider errors and must be noted in manifest/summary.
- Buffer: `pre_seconds` und `post_seconds` erweitern `visual_target_duration_seconds` und ComfyUI `target_frames`; Audio-Padding + Frame-Hold setzen den Mux-Horizont auf die gemessene gepaddete Audio-Dauer (`audio_duration_seconds`), die auch als `duration_cap_seconds` für `fertig.mp4` dient und ffmpeg-Driftprüfung (<1 Frame) sowie Mindestanzahl (>1 Frame) triggert. Endbild-Hold nutzt den Post-Puffer, wenn vorhanden.
- Prepare records SHA-256 hashes for start/audio/end inputs (or `INPUT_NOT_FOUND`), probes start resolution via ffprobe, clamps it to mod2 `max_width`/`max_height` (default 854x480) and resolves ComfyUI seeds per `seed_policy` (fixed/random), generating missing seeds within `0..4294967295`, storing them in manifest/effective_params, and passing the final seed to ComfyUI.
- Setup/Installer: `va doctor` checks `ffmpeg`/`ffprobe`/`node` (Python warning only) and exits 20 when ffmpeg/ffprobe fehlen; `skip_comfyui=true` überspringt ComfyUI-/Weights-/Node-Checks (Exit-Code basiert auf den übrigen Prüfungen). `va install-test` führt dieselbe Doctor-Prüfung aus, lädt aber nichts herunter und meldet fehlende Configs oder Assets mit `UNSUPPORTED_FORMAT` (Exit 20), damit frische Klones sehen, was noch fehlt. `va install` copies missing configs (`vidax.json`, `lipsync.providers.json`, `assets.json`) into `VA_STATE_DIR/state/config` (default base `~/.va/state`), ensures `state/comfyui/workflows` + `state/comfyui/models` + bundled sources under `state/assets/workflows`, and downloads/verifies assets via manifest resolution `VIDAX_ASSETS_CONFIG` → `VA_STATE_DIR/state/config/assets.json` → `config/assets.json` (SHA-256 enforced, `on_missing=download`, `on_hash_mismatch=fail`, `allow_insecure_http=false`, `unzip` required for `unpack=true`, hash errors → `UNSUPPORTED_FORMAT`, relative/file URLs resolve against the manifest directory). Optionaler Custom-Node-Block (default aktiv, steuerbar via `--no-comfy-nodes` oder `VA_INSTALL_COMFY_NODES=false`) klont/aktualisiert `Kosinkadink/ComfyUI-VideoHelperSuite` und `ShmuelRonen/ComfyUI_wav2lip` in `<COMFYUI_DIR>/custom_nodes/...` (default Windows `F:\ComfyUI\custom_nodes`, sonst `~/.va/state/comfyui/custom_nodes`), installiert deren `requirements.txt` mit dem bevorzugten ComfyUI-Python (erst `${COMFYUI_DIR}/venv/Scripts/python.exe` bzw. `${COMFYUI_DIR}/venv/bin/python`, Fallback `python`) und speichert die Wav2Lip-Weights exakt unter `ComfyUI_wav2lip/Wav2Lip/checkpoints/wav2lip_gan.pth` und `ComfyUI_wav2lip/Wav2Lip/face_detection/detection/sfd/s3fd.pth`; Fehler → `PYTHON_DEPENDENCY_FAILED` inkl. Repo/Python-Details. Der Installer zieht zusätzlich `imageio-ffmpeg` und per `-U` `soundfile` über das ermittelte ComfyUI-Python, pip-Fehler schlagen ebenfalls mit `PYTHON_DEPENDENCY_FAILED`. Hinweis auf nötigen ComfyUI-Neustart bleibt bestehen; beim Install-Lauf mit aktivem Custom-Node-Block wird `doctor` mit übersprungenem ComfyUI-Check ausgeführt, damit ein frisches System die Nodes/Weights erst anlegen kann. Der Doctor versucht einen optionalen `torchcodec`-Import über das ComfyUI-Python und warnt bei Fehlschlag, weil Audio I/O über soundfile läuft und keine torchaudio load/save-Pfade benötigt werden.
- Default workflow handling: `va produce` setzt je nach Startquelle `workflow_ids=["vidax_wav2lip_image_audio"]` (Startbild) oder `["vidax_wav2lip_video_audio"]`; `va run` übernimmt bereitgestellte IDs (empty + comfy enabled → Fehler). Der ComfyUI-Payload ist ein inline Wav2Lip-Flow mit Prompt-Links `["<node_id>", <output_index>]`: Startbild → `RepeatImageBatch(image, amount=frameCount)` → `LoadAudio` → `Wav2Lip(images,audio)` → `SaveImage(filename_prefix="vidax_wav2lip")`; Startvideo → `VHS_LoadVideo(force_rate=fps, frame_load_cap=frameCount, force_size=Custom w/h)` → `LoadAudio` → `Wav2Lip` → `SaveImage`. Render-Auflösung kommt aus Start-Probe, geklemmt auf `max_width`/`max_height`.
- ComfyUI-Staging: Inputs werden deterministisch ins Comfy-`input/` gelegt (Prio: `comfyui.input_dir` → `COMFYUI_INPUT_DIR` → `COMFYUI_DIR/input`; Windows-Default `F:\ComfyUI\input`), Dateinamen `vidax_audio_<sha16><ext>` und `vidax_start_<sha16><ext>`. Copy überschreibt nur bei unterschiedlicher Größe oder Force-Flag; HTTP-Uploads sind im Standardpfad nicht nötig.
- ComfyUI lifecycle defaults: health checks hit `/system_stats` (kein `/health`-Fallback), start defaults to `python main.py --listen 127.0.0.1 --port 8188` with CWD from config; on Windows `command="python"` prefers `<cwd>/venv/Scripts/python.exe` before the global `python`.
- Buffer-Pfade: `pre_seconds` und `post_seconds` sind aktiv; Audio wird für Buffer mit Stille gepaddet und Video hält letzte Frames für den Post-Puffer. Manifest führt `audio_input_duration_seconds`, `audio_duration_seconds`, `visual_target_duration_seconds` und `target_frames` basierend auf der gepaddeten Timeline.
- Default Workflow: Inline Wav2Lip-Flow wie oben beschrieben mit `frame_count=target_frames`, `frame_rate=fps`, SaveImage als primärem Output (Frames 6-stellig ab 000001, bei Bedarf zu Video gerendert). Asset-Datei `vidax_text2img_frames` bleibt als Referenz vorhanden, wird aber nicht als aktiver Default genutzt. Manifest `encode.completed` ergänzt `video_source_detail` (Startquelle, `comfyui_workflow_id`, `comfyui_output` video/frames, `lipsync` inside_comfy/external/off).
- Asset-Handling: Laufende ComfyUI-Instanzen mit `ok`-Health werden nicht durch fehlende Assets blockiert; Auto-Start erfordert gültige Manifest-Assets.
- Produce-Oberfläche: `va produce`/`POST /produce` bauen Job + Workdir (default `./workdir/run-<ts>` CLI bzw. `~/.va/state/runs/<run_id>` API), setzen `final_name=fertig.mp4` und starten den Run sofort.
- Wav2Lip-Node-Defaults: `mode` steht auf `sequential` und `face_detect_batch` auf `8`; beide Eingänge können über `comfyui.wav2lip.mode` bzw. `comfyui.wav2lip.face_detect_batch` im Job überschrieben werden und werden in Bild- wie Video-Prompts gesetzt.

## Style & Content
- Use deterministic terminology (fps, seed, resolution, target_frames) and emphasize audio-driven timing and trim rules.
- Prefer bullet lists or tables for flows; surface defaults, validation, and output locations clearly.
- Keep scope lean: focus on job spec, orchestration, ComfyUI REST, LipSync CLI, ffmpeg mux. Avoid workflow graphs.
- Manifest wording separates `run_status` (queued/running/completed/failed) from `exit_status` (success/failed/partial/null).
- VIDAX must manage ComfyUI lifecycle (health/start) before the comfyui runner phase; keep `docs/VIDAX_API.md` and `docs/SECURITY.md` aligned with actual runner/auth behavior.
- LipSync-Validation verlangt einen Provider nur bei `lipsync.enable=true`; ein gesetzter Provider bei `enable=false` wird als ignoriert markiert.
- Installer: Nach dem Clone/Update der Custom-Node-Repos werden vorhandene `requirements.txt` per ComfyUI-Python installiert (bevorzugt `${COMFYUI_DIR}/venv/Scripts/python.exe` auf Windows bzw. `${COMFYUI_DIR}/venv/bin/python`, Fallback `python`); Fehler werfen `PYTHON_DEPENDENCY_FAILED` inkl. Repo/Python-Details.

## Commit & PR
- Commit changes on the current branch and call `make_pr` with a PR message after committing.
- Summaries should highlight which specs or docs were added or updated.
