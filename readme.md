# VideoAudio Runner (Ist-Stand)

Skriptbarer Video+Audio-Runner: Job laden, validieren, optional über VIDAX starten und zu `final.mp4` encodieren. Dokumentation ist normativ, folgt aber dem aktuellen Codezustand.

## Requirements
- Node.js Runtime
- ffmpeg und ffprobe im PATH

## Quickstart (CLI)
1. `node src/main.js doctor` prüft ffmpeg/ffprobe/node (Exit 20 wenn ffmpeg/ffprobe fehlen).
2. Optional für frische Klones: `node src/main.js install-test` läuft dieselbe Doctor-Prüfung, lädt aber nichts herunter. Fehlende Configs oder Assets werden geloggt (Exit-Code 20 via `UNSUPPORTED_FORMAT`), damit du siehst, was `install` später anlegen müsste.
3. `node src/main.js install` legt StateDir + Configs an, zieht Assets gemäß Assets-Manifest (Auflösung: `VIDAX_ASSETS_CONFIG` → `VA_STATE_DIR/state/config/assets.json` → `config/assets.json`; StateDir via `VA_STATE_DIR`, default `~/.va/state`) und installiert optional ComfyUI-Custom-Nodes (`--no-comfy-nodes` oder `VA_INSTALL_COMFY_NODES=false` zum Abschalten). Für Custom Nodes ist `COMFYUI_DIR` Pflicht; das Ziel ist strikt `<COMFYUI_DIR>/custom_nodes/...` und der Installer meldet nach dem Kopieren `installed custom node vidax_wav2lip -> <target>`.
4. `node src/main.js produce --audio <A> --start <img|vid> [--end <img>] [--pre/post ...] [--width/height ...] [--max_width/max_height ...] [--lipsync on|off --lipsync_provider <id>] [--comfyui_chunk_size N] [--no-comfyui] [--workdir ...]` baut ein Job-JSON und startet den Run (Final-Basename `fertig.mp4`). Default: ComfyUI an, Lipsync für Startbilder aktiv (abschaltbar), Startvideo behält Lipsync aus; `--no-comfyui` nur für Diagnosefälle. Prompt/Negative sind optional und werden vom Default-Workflow nicht benötigt.
5. Alternativ: `node src/main.js validate path/to/job.json` und `node src/main.js run path/to/job.json --workdir /abs/workdir` (ComfyUI ist im Produktionspfad Pflicht: Health-Check zwingend auf `/system_stats` mit gültigem Body, `object_info` muss antworten; bei Ausfall `COMFYUI_UNAVAILABLE`, kein `/health`-Fallback; ein explizites `comfyui.enable=false`/`--no-comfyui` schaltet nur den Testpfad frei).
6. `VIDAX_CONFIG=... node src/vidax/server.js` startet die API (Config-Auflösung: `VIDAX_CONFIG` → `VA_STATE_DIR/state/config/vidax.json` → `config/vidax.json`)

## Features
### Implemented (Code)
- Setup/Installer: `va doctor` prüft ffmpeg/ffprobe/node (Python optional) und liefert Exit 20 bei fehlendem ffmpeg/ffprobe; `skip_comfyui=true` überspringt ComfyUI-/Weights-/Node-Checks (Exit-Code folgt den übrigen Prüfungen). `va install-test` läuft doctor + Asset/Config-Check ohne Downloads und meldet fehlende Ressourcen mit `UNSUPPORTED_FORMAT` (Exit 20), damit frische Klones sehen, was `install` anlegt. `va install` erzeugt StateDir unter `VA_STATE_DIR/state` (default `~/.va/state`), kopiert Beispiel-Configs in `state/config` (`vidax.json`, `lipsync.providers.json`, `assets.json`) und lädt/verifiziert Assets aus dem Manifest (SHA-256, `on_missing` default download, `on_hash_mismatch` fail → Fehlercode `HASH_MISMATCH`, `allow_insecure_http=false`, Redirects 301/302/303/307/308 bis zu 5 Hops inkl. User-Agent). Manifest-URLs unterstützen `file://`/relative Quellen (Basis = Manifest-Ordner); das frühere Referenz-Workflow-Asset `assets/workflows/vidax_text2img_frames.json` wird nicht mehr automatisch installiert, der aktive Default-Graph wird inline als Wav2Lip-Workflow gebaut. Optionaler ComfyUI-Custom-Nodes-Block (default aktiv, steuerbar über `--no-comfy-nodes` oder `VA_INSTALL_COMFY_NODES=false`) verlangt jetzt ein gesetztes `COMFYUI_DIR`, klont/aktualisiert `Kosinkadink/ComfyUI-VideoHelperSuite` und `ShmuelRonen/ComfyUI_wav2lip` strikt unter `<COMFYUI_DIR>/custom_nodes/...`, kopiert zusätzlich den repo-eigenen `vidax_wav2lip`-Node in `custom_nodes/vidax_wav2lip` (mit Log `installed custom node vidax_wav2lip -> <target>`), installiert vorhandene `requirements.txt` mit dem bevorzugten ComfyUI-Python (bevorzugt `${COMFYUI_DIR}/venv/Scripts/python.exe` bzw. `${COMFYUI_DIR}/venv/bin/python`, Fallback `python`) und legt die Wav2Lip-Weights exakt in `ComfyUI_wav2lip/Wav2Lip/checkpoints/wav2lip_gan.pth` sowie `ComfyUI_wav2lip/Wav2Lip/face_detection/detection/sfd/s3fd.pth` ab; Quellen für die Weights sind jetzt HuggingFace (`camenduru/Wav2Lip`), s3fd wird nach `s3fd.pth` umbenannt. Fehler liefern `PYTHON_DEPENDENCY_FAILED` mit Repo/Python-Details. Der Installer installiert zusätzlich `imageio-ffmpeg` und per `-U` `soundfile` über das ermittelte ComfyUI-Python, pip-Fehler schlagen mit `PYTHON_DEPENDENCY_FAILED`. Nach Abschluss folgt ein Neustart-Hinweis für ComfyUI; beim Installationslauf mit aktivem Custom-Node-Block wird `doctor` mit übersprungenem ComfyUI-Check ausgeführt, damit ein frisches System die Nodes/Weights erst anlegen kann. Der Doctor prüft `torchcodec` nur noch als Warnung, da der VIDAX-Wav2Lip-Pfad komplett auf `soundfile`/Resample setzt, und callt bei fehlendem VIDAX_Wav2Lip einen Restart-Hinweis aus.
- CLI-Kommandos `produce`, `validate`, `run`, `status`, `logs` mit Exit-Codes aus `src/errors.js`; `produce` baut/validiert ein Job-JSON aus Flags und startet sofort (Workdir default `./workdir/run-<ts>`, Final `fertig.mp4`), `run` kennt `--workdir` und `--resume`; ComfyUI ist default aktiv (Health-Pflicht), ein explizites Disable dient nur der Diagnose.
- Manifest + Registry: Runs werden unter `~/.va/state/runs.json` registriert; `manifest.json` hält `run_status`/`exit_status`, Phasen, Seeds (inkl. Policy), Audio-Input- und gepaddete Dauer, Buffer, Zielzeit/FPS/Frames sowie applied Params. Encode completed notiert zusätzlich `video_source_detail` mit `start_source` (`start_image`/`start_video`), `comfyui_workflow_id`, `comfyui_output` (`video`/`frames`), `lipsync` (`inside_comfy`/`external`/`off`) und die Degradationsmarkierungen (`degraded`, `degraded_reason`).
- Prepare: Audio-Dauer via `ffprobe`; Buffer `pre_seconds`/`post_seconds` erweitern `visual_target_duration_seconds` und die ComfyUI-Ziel-Frames; Audio wird bei Buffern mit Stille gepaddet, die gemessene gepaddete Länge landet als `audio_duration_seconds` **und** `visual_target_duration_seconds`, Originaldauer bleibt als `audio_input_duration_seconds`; Input-Hashes sind echte SHA-256-Werte oder `INPUT_NOT_FOUND`; ComfyUI-Seed wird gemäß `seed_policy` (fixed/random) validiert/generiert, im Manifest und `effective_params` abgelegt und an ComfyUI durchgereicht. Die Render-Auflösung wird aus dem Start-Bild/Video geprobt, mod2 geklemmt auf `max_width`/`max_height` (Default 854x480) und überall weitergereicht.
- ComfyUI: Pflicht im Produktionspfad (Health-Check strikt auf `/system_stats` mit gültigem Body, `object_info` Pflicht; Fehler → `COMFYUI_UNAVAILABLE`). Inline API-Graphen bauen Audio-getriebene Wav2Lip-Workflows mit Prompt-Links `["<node_id>", <output_index>]`: Startbild → `RepeatImageBatch(image, frame_count=target_frames)` → `LoadAudio` → `VIDAX_Wav2Lip(on_no_face=passthrough)` → `SaveImage(filename_prefix=vidax_wav2lip)`, Startvideo → `VHS_LoadVideo(force_rate=fps, frame_load_cap=target_frames, force_size=Custom w/h)` → `LoadAudio` → `VIDAX_Wav2Lip(on_no_face=passthrough)` → `SaveImage`. Outputs landen als Frames (`workdir/frames/000001.png`, ...; sortiert nach Original-Filename und bei Bedarf zu `comfyui/comfyui_video.mp4` gerendert), Manifest zeichnet `chunk_size=target_frames`/`chunk_count=1`, `workflow_id`, `prompt_id` und Output-Pfade auf. Inputs werden deterministisch in das Comfy-`input/` kopiert (Priorität `comfyui.input_dir` → `COMFYUI_INPUT_DIR` → `COMFYUI_DIR/input`, Windows-Default `F:\ComfyUI\input`) mit Dateinamen `vidax_audio_<sha16><ext>` und `vidax_start_<sha16><ext>`; Kopien überschreiben nur bei unterschiedlicher Größe/Force. Default-IDs: Startbild → `["vidax_faceprobe","vidax_motion_chunks","vidax_lipsync_mouthblend"]` (Lipsync default an), Startvideo → `["vidax_wav2lip_video_audio"]`. Fehlende Nodes/Weights oder fehlende Comfy-Outputs führen zu `COMFYUI_BAD_RESPONSE`; der Runner erzeugt trotzdem ein fallback-Video aus Startbild/-video, markiert `degraded=true` und nutzt den Basisclip für den Encode; fehlende Outputs werden mit kompakten `history_keys`/`output_keys`/`messages`/`node_errors` protokolliert.
- Output parsing toleriert direkte `images`/`videos`-Payloads aus der ComfyUI-History (auch ohne numerische Keys) und erkennt auch History-Einträge, die Medien nicht unter `outputs` ablegen, damit `COMFYUI_OUTPUTS_MISSING` nur dann feuert, wenn wirklich kein Medien-Output geliefert wurde.
- Faceprobe-ComfyUI-Läufe sind optional: liefert ComfyUI nichts zurück, loggen wir einen Warnhinweis, behalten die lokal berechnete `face_meta` und werfen keine `COMFYUI_OUTPUTS_MISSING`-Exception.
- Wav2Lip-Node: VIDAX-eigener Custom Node exportiert `VIDAX_Wav2Lip` und `VIDAX_LoadAudio`; `class_type=VIDAX_Wav2Lip` setzt `mode` auf `sequential`, `face_detect_batch` auf `8` und `on_no_face` auf `passthrough` als Defaults, `VIDAX_LoadAudio` lädt Mono-Waveforms aus einem Pfad. Felder lassen sich über das Job-JSON überschreiben (`comfyui.wav2lip.mode`, `comfyui.wav2lip.face_detect_batch`, `comfyui.wav2lip.on_no_face`). Audio I/O läuft über `soundfile` + 16 kHz Resample, ohne torchaudio.save/torchcodec, und fallbackt auf Passthrough wenn keine Frames zurückkommen (außer `on_no_face=error`).
- LipSync: Läuft nur bei `lipsync.enable` (default off) **und** vorhandenem Provider; Config wird zuerst unter `VA_STATE_DIR/state/config/lipsync.providers.json` (bzw. `state_dir` aus `vidax.json`) gesucht, Fallback `config/lipsync.providers.json`; Output `workdir/lipsync/output.mp4`; Provider-Fehler oder fehlende Frames führen zu `degraded=true` und der Encode nutzt das Basisvideo ohne zusätzliche LipSync-Spur (auch wenn `allow_passthrough` nicht gesetzt). Validation fordert einen Provider nur bei `enable=true`; ein Provider bei `enable=false` wird als ignoriert markiert.
- Encode: Reales ffmpeg-Muxing (CFR auf `determinism.fps`) mit gemessener gepaddeter Audio-Timeline als Ziel (`duration_cap_seconds` = `audio_duration_seconds`), Drift-Toleranz < 1 Frame, Ausgaben mit ≤1 Frame schlagen hart mit `FFMPEG_FAILED` fehl, Scaling auf die abgeleitete Render-Auflösung, optional Endbild-Hold im Post-Puffer (wenn `end_image` und `post_seconds>0`), Post-Puffer via Frame-Hold. Bei Endbild-Hold reduziert der ComfyUI-Auftrag die Frame-Anzahl um die Post-Puffer-Frames; die fehlenden Frames kommen ausschließlich aus dem angehängten Hold-Clip. Visual-Priorität: Bei aktivem ComfyUI wird dessen Output bevorzugt, andernfalls wird das Basisvideo encodiert; finale Ausgaben entstehen auch im degradierten Pfad (Zoompan-Basisvideo bei Startbild oder Startvideo-Passthrough), End-Holds werden via re-encoded Concat (scale/fps/yuv420p) an die Hauptspur gehängt.
- Overwrite/Resume: `final.mp4`/`fertig.mp4` blockiert neuen Lauf ohne `--resume`; Resume verlangt existierendes Manifest und fehlendes Final.
- Logging: `logs/events.jsonl` mit Zeitstempel + Stage/Level; CLI `logs` streamt diese Datei.
- VIDAX API: `GET /health`, `GET /install/status`, `POST /install`, `GET /comfyui/health`, `POST /comfyui/start`, `POST /produce`, `POST /jobs`, `POST /jobs/:id/start`, `GET /jobs/:id`, `/manifest`, `/logs`; API-Key Pflicht über `X-API-Key`, Bind default `127.0.0.1`. ComfyUI-Health nutzt strikt `/system_stats` (kein `/health`-Fallback), Start-Defaults: `python main.py --listen 127.0.0.1 --port 8188`, CWD aus Config; unter Windows wird bei `command=\"python\"` zuerst `venv/Scripts/python.exe` im CWD versucht.

### Anime-/MouthBlend-Pfad
- Startbild-Läufe setzen per Default die Workflow-Liste auf `vidax_faceprobe`, `vidax_motion_chunks`, `vidax_lipsync_mouthblend`; `lipsync` ist dabei standardmäßig aktiv (abschaltbar via Flag/JSON). Startvideo behält den klassischen Wav2Lip-Graphen.
- Faceprobe: Vor jedem Startbild-Lauf wird lokal ein Face-Crop + `face_meta` erzeugt (`faceprobe/face_meta.json`, Debug-Kopie unter `faceprobe/debug/`); ein fehlender Crop wirft `COMFYUI_FACE_NOT_FOUND`. Wenn ein entsprechender Workflow mitläuft, wird ComfyUI zusätzlich für Debug-Saves angesteuert; die Bounding-Box entsteht aber deterministisch aus der Bildgröße (square pad, MouthROI im unteren Drittel). InsightFace/RetinaFace oder andere Detectoren sind im VIDAX-Core aktuell nicht integriert.
- Motion/Lipsync: Chunk-Motion-Prompts schreiben Frames unter `motion/frames/` (Meta `fps`/`frame_count` landet in `manifest.motion_meta`), MouthBlend läuft über einen eigenen Comfy-Graph (Frames unter `mouthblend/frames/`) und markiert Lipsync als `inside_comfy`. Manifest ergänzt `face_meta`, `motion_meta`, `lipsync_meta`.
- Fallbacks: Fehlen ComfyUI-Outputs oder schlägt LipSync fehl, wird `degraded=true` gesetzt und das Basisvideo ohne zusätzliche LipSync-Spur encodiert; die Motion-Basis nutzt einen linearen, geklemmten `zoompan`-Filter ohne `+-`/`zoom=`-Artefakte, und wenn die Motion-Erzeugung dennoch scheitert, wird `degraded_reason=MOTION_VIDEO_FAILED` gesetzt und ein `still_emergency`-Clip als Notanker encodiert.

### Planned / Not in Code
- Motion-Stärkeregler, Timing-Files aus den Specs werden nicht validiert oder angewendet.
- Retry-/Backoff-Policy für ComfyUI und Stabilize-Phase fehlen; `seed_policy=per_retry` wird nicht unterstützt.
- Manifest-Erweiterungen wie eine `runner.log` Alternative bleiben offen; automatisches Frames-Cleanup ist weiterhin manuell, die Temp-Bereinigung läuft nach erfolgreichen Runs.
- VIDAX-Fehlercodes für spezifische Startfehler (z.B. `COMFYUI_START_FAILED`) und API-gesteuerte Partial/Resume-Semantik sind nicht vorhanden.

## Docs (Entry Points)
- [`docs/JOB_SCHEMA.md`](docs/JOB_SCHEMA.md)
- [`docs/OUTPUT_CONTRACT.md`](docs/OUTPUT_CONTRACT.md)
- [`docs/COMFYUI_INTERFACE.md`](docs/COMFYUI_INTERFACE.md)
- [`docs/LIPSYNC_INTERFACE.md`](docs/LIPSYNC_INTERFACE.md)
- [`docs/VIDAX_API.md`](docs/VIDAX_API.md)
- [`docs/SECURITY.md`](docs/SECURITY.md)
- [`docs/OPEN_DECISIONS.md`](docs/OPEN_DECISIONS.md)
- [`docs/SETUP.md`](docs/SETUP.md)
- [`docs/ASSETS.md`](docs/ASSETS.md)
