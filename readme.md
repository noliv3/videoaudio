# VideoAudio Runner (Ist-Stand)

Skriptbarer Video+Audio-Runner: Job laden, validieren, optional über VIDAX starten und zu `final.mp4` encodieren. Dokumentation ist normativ, folgt aber dem aktuellen Codezustand.

## Requirements
- Node.js Runtime
- ffmpeg und ffprobe im PATH

## Quickstart (CLI)
1. `node src/main.js doctor` prüft ffmpeg/ffprobe/node (Exit 20 wenn ffmpeg/ffprobe fehlen).
2. Optional für frische Klones: `node src/main.js install-test` läuft dieselbe Doctor-Prüfung, lädt aber nichts herunter. Fehlende Configs oder Assets werden geloggt (Exit-Code 20 via `UNSUPPORTED_FORMAT`), damit du siehst, was `install` später anlegen müsste.
3. `node src/main.js install` legt StateDir + Configs an, zieht Assets gemäß Assets-Manifest (Auflösung: `VIDAX_ASSETS_CONFIG` → `VA_STATE_DIR/state/config/assets.json` → `config/assets.json`; StateDir via `VA_STATE_DIR`, default `~/.va/state`) und installiert optional ComfyUI-Custom-Nodes (`--no-comfy-nodes` oder `VA_INSTALL_COMFY_NODES=false` zum Abschalten). `COMFYUI_DIR` setzt das Ziel für Custom Nodes (default `F:\ComfyUI\custom_nodes` unter Windows, sonst `~/.va/state/comfyui/custom_nodes`).
4. `node src/main.js produce --audio <A> --start <img|vid> [--end <img>] [--pre/post ...] [--width/height ...] [--max_width/max_height ...] [--lipsync on|off --lipsync_provider <id>] [--comfyui_chunk_size N] [--no-comfyui] [--workdir ...]` baut ein Job-JSON und startet den Run (Final-Basename `fertig.mp4`). Default: ComfyUI an, Lipsync aus; `--no-comfyui` nur für Diagnosefälle. Prompt/Negative sind optional und werden vom Default-Workflow nicht benötigt.
5. Alternativ: `node src/main.js validate path/to/job.json` und `node src/main.js run path/to/job.json --workdir /abs/workdir` (ComfyUI ist im Produktionspfad Pflicht: Health-Check zwingend auf `/system_stats` mit gültigem Body, `object_info` muss antworten; bei Ausfall `COMFYUI_UNAVAILABLE`, kein `/health`-Fallback; ein explizites `comfyui.enable=false`/`--no-comfyui` schaltet nur den Testpfad frei).
6. `VIDAX_CONFIG=... node src/vidax/server.js` startet die API (Config-Auflösung: `VIDAX_CONFIG` → `VA_STATE_DIR/state/config/vidax.json` → `config/vidax.json`)

## Features
### Implemented (Code)
- Setup/Installer: `va doctor` prüft ffmpeg/ffprobe/node (Python optional) und liefert Exit 20 bei fehlendem ffmpeg/ffprobe; `skip_comfyui=true` überspringt ComfyUI-/Weights-/Node-Checks (Exit-Code folgt den übrigen Prüfungen). `va install-test` läuft doctor + Asset/Config-Check ohne Downloads und meldet fehlende Ressourcen mit `UNSUPPORTED_FORMAT` (Exit 20), damit frische Klones sehen, was `install` anlegt. `va install` erzeugt StateDir unter `VA_STATE_DIR/state` (default `~/.va/state`), kopiert Beispiel-Configs in `state/config` (`vidax.json`, `lipsync.providers.json`, `assets.json`) und lädt/verifiziert Assets aus dem Manifest (SHA-256, `on_missing` default download, `on_hash_mismatch` fail, `allow_insecure_http=false`, hash-Fehler → `UNSUPPORTED_FORMAT`). Manifest-URLs unterstützen `file://`/relative Quellen (Basis = Manifest-Ordner); das gebündelte Produktions-Workflow-Asset `assets/workflows/vidax_text2img_frames.json` bleibt als Referenz unter `state/comfyui/workflows/`, der aktive Default-Graph wird inline als Wav2Lip-Workflow gebaut. Optionaler ComfyUI-Custom-Nodes-Block (default aktiv, steuerbar über `--no-comfy-nodes` oder `VA_INSTALL_COMFY_NODES=false`) klont/aktualisiert `Kosinkadink/ComfyUI-VideoHelperSuite` und `ShmuelRonen/ComfyUI_wav2lip` strikt unter `<COMFYUI_DIR>/custom_nodes/...` (default Windows `F:\ComfyUI\custom_nodes`, sonst `~/.va/state/comfyui/custom_nodes`), installiert deren `requirements.txt` mit dem bevorzugten ComfyUI-Python (bevorzugt `${COMFYUI_DIR}/venv/Scripts/python.exe` bzw. `${COMFYUI_DIR}/venv/bin/python`, Fallback `python`) und legt die Wav2Lip-Weights exakt in `ComfyUI_wav2lip/Wav2Lip/checkpoints/wav2lip_gan.pth` sowie `ComfyUI_wav2lip/Wav2Lip/face_detection/detection/sfd/s3fd.pth` ab; Fehler liefern `PYTHON_DEPENDENCY_FAILED` mit Repo/Python-Details. Nach Abschluss folgt ein Neustart-Hinweis für ComfyUI; beim Installationslauf mit aktivem Custom-Node-Block wird `doctor` mit übersprungenem ComfyUI-Check ausgeführt, damit ein frisches System die Nodes/Weights erst anlegen kann.
- CLI-Kommandos `produce`, `validate`, `run`, `status`, `logs` mit Exit-Codes aus `src/errors.js`; `produce` baut/validiert ein Job-JSON aus Flags und startet sofort (Workdir default `./workdir/run-<ts>`, Final `fertig.mp4`), `run` kennt `--workdir` und `--resume`; ComfyUI ist default aktiv (Health-Pflicht), ein explizites Disable dient nur der Diagnose.
- Manifest + Registry: Runs werden unter `~/.va/state/runs.json` registriert; `manifest.json` hält `run_status`/`exit_status`, Phasen, Seeds (inkl. Policy), Audio-Input- und gepaddete Dauer, Buffer, Zielzeit/FPS/Frames sowie applied Params. Encode completed notiert zusätzlich `video_source_detail` mit `start_source` (`start_image`/`start_video`), `comfyui_workflow_id`, `comfyui_output` (`video`/`frames`) und `lipsync` (`inside_comfy`/`external`/`off`).
- Prepare: Audio-Dauer via `ffprobe`; Buffer `pre_seconds`/`post_seconds` erweitern `visual_target_duration_seconds` und die ComfyUI-Ziel-Frames; Audio wird bei Buffern mit Stille gepaddet, die gemessene gepaddete Länge landet als `audio_duration_seconds` **und** `visual_target_duration_seconds`, Originaldauer bleibt als `audio_input_duration_seconds`; Input-Hashes sind echte SHA-256-Werte oder `INPUT_NOT_FOUND`; ComfyUI-Seed wird gemäß `seed_policy` (fixed/random) validiert/generiert, im Manifest und `effective_params` abgelegt und an ComfyUI durchgereicht. Die Render-Auflösung wird aus dem Start-Bild/Video geprobt, mod2 geklemmt auf `max_width`/`max_height` (Default 854x480) und überall weitergereicht.
- ComfyUI: Pflicht im Produktionspfad (Health-Check strikt auf `/system_stats` mit gültigem Body, `object_info` Pflicht; Fehler → `COMFYUI_UNAVAILABLE`, kein Dummy-Skip). Inline API-Graphen bauen Audio-getriebene Wav2Lip-Workflows mit Prompt-Links `["<node_id>", <output_index>]`: Startbild → `RepeatImageBatch(image, frame_count=target_frames)` → `LoadAudio` → `Wav2Lip` → `SaveImage(filename_prefix=vidax_wav2lip)`, Startvideo → `VHS_LoadVideo(force_rate=fps, frame_load_cap=target_frames, force_size=Custom w/h)` → `LoadAudio` → `Wav2Lip` → `SaveImage`. Outputs landen als Frames (`workdir/frames/000001.png`, ...; sortiert nach Original-Filename und bei Bedarf zu `comfyui/comfyui_video.mp4` gerendert), Manifest zeichnet `chunk_size=target_frames`/`chunk_count=1`, `workflow_id`, `prompt_id` und Output-Pfade auf. Inputs werden deterministisch in das Comfy-`input/` kopiert (Priorität `comfyui.input_dir` → `COMFYUI_INPUT_DIR` → `COMFYUI_DIR/input`, Windows-Default `F:\ComfyUI\input`) mit Dateinamen `vidax_audio_<sha16><ext>` und `vidax_start_<sha16><ext>`; Kopien überschreiben nur bei unterschiedlicher Größe/Force. Default-IDs: `vidax_wav2lip_image_audio` (Startbild) bzw. `vidax_wav2lip_video_audio` (Startvideo). Fehlende Nodes/Weights oder fehlende Comfy-Outputs führen zu `COMFYUI_BAD_RESPONSE`, solange ComfyUI aktiv ist gibt es keinen Fallback-Encode.
- Wav2Lip-Node: Setzt `mode` auf `sequential` und `face_detect_batch` auf `8` als Defaults; beide Felder lassen sich über das Job-JSON überschreiben (`comfyui.wav2lip.mode`, `comfyui.wav2lip.face_detect_batch`) und werden in Bild- wie Video-Workflows mitgegeben.
- LipSync: Läuft nur bei `lipsync.enable` (default off) **und** vorhandenem Provider; Config wird zuerst unter `VA_STATE_DIR/state/config/lipsync.providers.json` (bzw. `state_dir` aus `vidax.json`) gesucht, Fallback `config/lipsync.providers.json`; Output `workdir/lipsync/output.mp4`; `allow_passthrough=true` erlaubt Encode trotz Fehler; verarbeitet gepaddete Audioquelle. Validation fordert einen Provider nur bei `enable=true`; ein Provider bei `enable=false` wird als ignoriert markiert.
- Encode: Reales ffmpeg-Muxing (CFR auf `determinism.fps`) mit gemessener gepaddeter Audio-Timeline als Ziel (`duration_cap_seconds` = `audio_duration_seconds`), Drift-Toleranz < 1 Frame, Ausgaben mit ≤1 Frame schlagen hart mit `FFMPEG_FAILED` fehl, Scaling auf die abgeleitete Render-Auflösung, optional Endbild-Hold im Post-Puffer (wenn `end_image` und `post_seconds>0`), Post-Puffer via Frame-Hold. Bei Endbild-Hold reduziert der ComfyUI-Auftrag die Frame-Anzahl um die Post-Puffer-Frames; die fehlenden Frames kommen ausschließlich aus dem angehängten Hold-Clip. Visual-Priorität: Bei aktivem ComfyUI wird das erzeugte `comfyui_video.mp4` (oder die daraus konvertierten Frames) encodiert; bei deaktiviertem ComfyUI bleibt `start_video` Primärquelle, Startbild löst einen Ken-Burns-Motion-Fallback aus, Still-Dummy bleibt letzter Notanker. End-Holds werden via re-encoded Concat (scale/fps/yuv420p) an die Hauptspur gehängt, damit Startvideo + Hold stabil bleiben.
- Overwrite/Resume: `final.mp4`/`fertig.mp4` blockiert neuen Lauf ohne `--resume`; Resume verlangt existierendes Manifest und fehlendes Final.
- Logging: `logs/events.jsonl` mit Zeitstempel + Stage/Level; CLI `logs` streamt diese Datei.
- VIDAX API: `GET /health`, `GET /install/status`, `POST /install`, `GET /comfyui/health`, `POST /comfyui/start`, `POST /produce`, `POST /jobs`, `POST /jobs/:id/start`, `GET /jobs/:id`, `/manifest`, `/logs`; API-Key Pflicht über `X-API-Key`, Bind default `127.0.0.1`. ComfyUI-Health nutzt strikt `/system_stats` (kein `/health`-Fallback), Start-Defaults: `python main.py --listen 127.0.0.1 --port 8188`, CWD aus Config; unter Windows wird bei `command=\"python\"` zuerst `venv/Scripts/python.exe` im CWD versucht.

### Planned / Not in Code
- Motion-Stärkeregler, Timing-Files aus den Specs werden nicht validiert oder angewendet.
- Retry-/Backoff-Policy für ComfyUI und Stabilize-Phase fehlen; `seed_policy=per_retry` wird nicht unterstützt.
- Manifest-Erweiterungen wie eine `runner.log` Alternative bleiben offen; automatisches Frames-Cleanup ist weiterhin manuell, die Temp-Bereinigung läuft nach erfolgreichen Runs.
- VIDAX-Fehlercodes für spezifische Startfehler (z.B. `COMFYUI_START_FAILED`) und API-gesteuerte Partial/Resume-Semantik sind nicht vorhanden.

## Docs (Entry Points)
- [`docs/JOB_SCHEMA.md`](docs/JOB_SCHEMA.md)
- [`docs/OUTPUT_CONTRACT.md`](docs/OUTPUT_CONTRACT.md)
- [`docs/COMFYUI_INTERFACE.md`](docs/COMFYUI_INTERFACE.md)
- [`docs/LIPSYNC_INTERFACE.md`](docs/LIPSYNC_INTERFACE.md)
- [`docs/VIDAX_API.md`](docs/VIDAX_API.md)
- [`docs/SECURITY.md`](docs/SECURITY.md)
- [`docs/OPEN_DECISIONS.md`](docs/OPEN_DECISIONS.md)
- [`docs/SETUP.md`](docs/SETUP.md)
- [`docs/ASSETS.md`](docs/ASSETS.md)
