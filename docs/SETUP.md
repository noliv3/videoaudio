# Setup & Install Flow

- **StateDir**: Default `~/.va/state` for assets/configs (override base via `VA_STATE_DIR`). Layout created by `va install` → `comfyui/workflows/`, `comfyui/models/`, `assets/workflows/`, `config/`, `runs/`.
- **Config Copy**: Missing configs are cloned from `config/*.example.json` into `VA_STATE_DIR/state/config/vidax.json`, `lipsync.providers.json`, and `assets.json` (override path via `VIDAX_ASSETS_CONFIG`). Paths starting with `~/` are expanded when VIDAX loads config.
- **Config Resolution**: VIDAX reads config from `VIDAX_CONFIG` or `VA_STATE_DIR/state/config/vidax.json`, falling back to `config/vidax.json`. Assets manifest resolves via `VIDAX_ASSETS_CONFIG` → `VA_STATE_DIR/state/config/assets.json` → `config/assets.json`; `file://` und relative Pfade werden relativ zum Manifest-Ordner aufgelöst.
- **Doctor**: `va doctor` checks `ffmpeg`, `ffprobe`, `node` (Python is a non-critical warning). Missing critical tools exit with code 20 (`UNSUPPORTED_FORMAT` mapping); ok exit is 0.
- **Install-Test**: `va install-test` runs the same doctor pass without downloading or writing assets/configs. Missing configs or assets return `UNSUPPORTED_FORMAT` (exit 20) and print the manifest path plus missing targets so a fresh clone can see what `install` will create.
- **Install**: `va install` runs Doctor (unless `--skip-doctor`), ensures StateDir layout, copies configs into `state/config`, und legt gebündelte Workflow-Quellen unter `state/assets/workflows/` ab. Assets aus dem Manifest (inkl. Referenz-Workflow `assets/workflows/vidax_text2img_frames.json`) werden mit realem SHA-256 nach `state/comfyui/workflows/` installiert/verifiziert (`on_missing=download`, `on_hash_mismatch=fail`, `allow_insecure_http=false`, Redirects 301/302/303/307/308 bis max 5 Hops mit User-Agent, `unpack` uses `unzip`). Failure to install or verify assets surfaces `UNSUPPORTED_FORMAT` for download/hash issues or `OUTPUT_WRITE_FAILED` for write/unzip problems.
- **ComfyUI Custom Nodes**: Der optionale Install-Block (aktiv sofern nicht `--no-comfy-nodes`/`VA_INSTALL_COMFY_NODES=false`) klont/aktualisiert `Kosinkadink/ComfyUI-VideoHelperSuite` und `ShmuelRonen/ComfyUI_wav2lip` strikt nach `<COMFYUI_DIR>/custom_nodes/...` (Default Windows `F:\ComfyUI\custom_nodes`, sonst `~/.va/state/comfyui/custom_nodes`), kopiert den repo-eigenen `vidax_wav2lip`-Node nach `custom_nodes/vidax_wav2lip`, installiert vorhandene `requirements.txt` per ComfyUI-Python (Prio `${COMFYUI_DIR}/venv/Scripts/python.exe` bzw. `${COMFYUI_DIR}/venv/bin/python`, Fallback `python`) und lädt die Wav2Lip-Weights von HuggingFace (`camenduru/Wav2Lip`) nach `ComfyUI_wav2lip/Wav2Lip/checkpoints/wav2lip_gan.pth` sowie `ComfyUI_wav2lip/Wav2Lip/face_detection/detection/sfd/s3fd.pth` (Quelle `s3fd-619a316812.pth`, Zielname `s3fd.pth`). Fehler bei den Python-Abhängigkeiten melden `PYTHON_DEPENDENCY_FAILED`; nach erfolgreicher Installation ist ein ComfyUI-Neustart nötig. Torchcodec wird nur warnend geprüft, da der VIDAX-Wav2Lip-Pfad auf `soundfile` + Resample setzt.
- **ComfyUI Paths**: If `comfyui.paths.workflows_dir` / `models_dir` are set in `vidax.json`, VIDAX exports them as environment variables for ComfyUI. Defaults fall back to the StateDir paths above (workflows/models under `state/`).
- **Server Integration**: `POST /install` triggers the same asset install routine; `GET /install/status` reports missing or mismatched assets without downloading.
- **Retry Notes**: `unzip` is required to unpack assets with `unpack=true`; if unavailable, installation fails with `OUTPUT_WRITE_FAILED`.
- **Fehlende Assets**: Läuft ComfyUI bereits gesund, blockieren fehlende Assets den Job-Start nicht; beim Auto-Start sind Workflows/Models aus dem Manifest Pflicht. `GET/POST /install` listen weiterhin fehlende oder fehlerhafte Einträge auf.
- **Model-Hinweis**: Der gebündelte SDXL-Referenz-Workflow erwartet einen Checkpoint (z. B. `sd_xl_base_1.0.safetensors`) im Models-Verzeichnis; das Manifest liefert keine Modelle mit. Der produktive Wav2Lip-Graph läuft inline ohne zusätzliche Model-Assets aus dem Manifest.
